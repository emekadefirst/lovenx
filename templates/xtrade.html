{% extends 'base.html' %}
{% load humanize %}
{% block content %}

<style>
    :root {
        --background: #ffffff;
        --foreground: #0a0a0a;
        --card: #ffffff;
        --card-foreground: #0a0a0a;
        --primary: #030213;
        --primary-foreground: #ffffff;
        --secondary: #f3f4f6;
        --secondary-foreground: #030213;
        --muted: #ececf0;
        --muted-foreground: #717182;
        --accent: #e9ebef;
        --accent-foreground: #030213;
        --destructive: #d4183d;
        --destructive-foreground: #ffffff;
        --border: rgba(0, 0, 0, 0.1);
        --ring: #9ca3af;
        --chart-1: #f59e0b;
        --chart-2: #10b981;
        --chart-3: #3b82f6;
        --chart-4: #8b5cf6;
        --chart-5: #ef4444;
        --radius: 0.625rem;
    }

    body {
        background-color: var(--background);
        color: var(--foreground);
    }

    .bg-background {
        background-color: var(--background);
    }

    .bg-card {
        background-color: var(--card);
    }

    .bg-primary {
        background-color: var(--primary);
    }

    .bg-secondary {
        background-color: var(--secondary);
    }

    .bg-muted {
        background-color: var(--muted);
    }

    .bg-accent {
        background-color: var(--accent);
    }

    .text-foreground {
        color: var(--foreground);
    }

    .text-primary {
        color: var(--primary);
    }

    .text-primary-foreground {
        color: var(--primary-foreground);
    }

    .text-muted-foreground {
        color: var(--muted-foreground);
    }

    .border-border {
        border-color: var(--border);
    }

    .text-chart-1 {
        color: var(--chart-1);
    }

    .text-chart-2 {
        color: var(--chart-2);
    }

    .text-chart-3 {
        color: var(--chart-3);
    }

    .text-chart-4 {
        color: var(--chart-4);
    }

    .text-chart-5 {
        color: var(--chart-5);
    }

    .price-up {
        color: var(--chart-2);
    }

    .price-down {
        color: var(--chart-5);
    }

    .input-field {
        background-color: var(--secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 8px 12px;
        width: 100%;
        transition: all 0.2s ease;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary);
    }

    .btn-buy {
        background-color: var(--chart-2);
        color: white;
        border-radius: var(--radius);
        padding: 8px 16px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
        width: 100%;
    }

    .btn-sell {
        background-color: var(--chart-5);
        color: white;
        border-radius: var(--radius);
        padding: 8px 16px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
        width: 100%;
    }

    .btn-buy:hover,
    .btn-sell:hover {
        opacity: 0.9;
    }

    .order-book-row:hover {
        background-color: var(--muted);
    }

    .tab-button {
        padding: 8px 16px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background-color: var(--background);
        color: var(--foreground);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .tab-button.active {
        background-color: var(--primary);
        color: var(--primary-foreground);
        border-color: var(--primary);
    }

    .chart-container {
        position: relative;
        height: 400px;
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 16px;
    }

    .order-book {
        max-height: 300px;
        overflow-y: auto;
    }

    .order-book-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }

    .order-book-header {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        font-size: 12px;
        font-weight: 600;
        border-bottom: 1px solid var(--border);
        margin-bottom: 8px;
    }

    .balance-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
    }

    .balance-item:last-child {
        border-bottom: none;
    }

    .trading-form {
        background-color: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        margin-bottom: 4px;
        font-size: 14px;
        font-weight: 500;
        color: var(--foreground);
    }

    .percentage-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .percentage-btn {
        flex: 1;
        padding: 4px 8px;
        font-size: 12px;
        background-color: var(--secondary);
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .percentage-btn:hover {
        background-color: var(--muted);
    }
</style>

<div class="container mx-auto px-6 py-6"> 
    <!-- Market Selector -->
    <div class="mb-6">
        <div class="flex items-center space-x-4 mb-4">
            <select id="marketSelector" class="input-field w-auto" onchange="changeMarket()">
                <option value="{{ coin.symbol }}/NGN">{{ coin.symbol }}/NGN</option>
            </select>
            <div class="flex items-center space-x-2">
                <span class="text-2xl font-bold" id="currentPrice">
                    ₦{{ coin.price|floatformat:2|intcomma }}
                </span>
                <span 
                  class="{% if coin.percent_change_24h >= 0 %}price-up{% else %}price-down{% endif %}" 
                  id="priceChange">
                  {{ coin.percent_change_24h|floatformat:2 }}%
                </span>
            </div>
        </div>

        <!-- Market Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-card border border-border rounded-lg p-4">
                <div class="text-sm text-muted-foreground">24h High</div>
                <div class="font-medium" id="high24h">
                    ₦{{ coin.24h_high }}
                </div>
            </div>
            <div class="bg-card border border-border rounded-lg p-4">
                <div class="text-sm text-muted-foreground">24h Low</div>
                <div class="font-medium" id="low24h">
                    ₦{{ coin.24h_low }}
                </div>
            </div>
            <div class="bg-card border border-border rounded-lg p-4">
                <div class="text-sm text-muted-foreground">24h Volume</div>
                <div class="font-medium" id="volume24h">
                    ₦{{ coin.24h_volume }}
                </div>
            </div>
            <div class="bg-card border border-border rounded-lg p-4">
                <div class="text-sm text-muted-foreground">Market Cap</div>
                <div class="font-medium" id="marketCap">
                    ₦{{ coin.market_cap|floatformat:2|intcomma  }}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Trading Interface -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Chart and Order Book Section -->
        <div class="lg:col-span-2">
            <!-- Price Chart -->
            <div class="bg-card border border-border rounded-lg p-6 mb-6">
                <div class="flex items-center space-x-4 mb-4">
                    <h3 class="text-lg font-semibold">{{ coin.symbol }}/NGN Chart</h3>
                    <div class="flex space-x-2">
                        <button class="tab-button active" onclick="switchTimeframe('1H')">1H</button>
                        <button class="tab-button" onclick="switchTimeframe('1D')">1D</button>
                        <button class="tab-button" onclick="switchTimeframe('7D')">7D</button>
                        <button class="tab-button" onclick="switchTimeframe('1M')">1M</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- Order Book -->
            <div class="bg-card border border-border rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Order Book</h3>
                <div class="order-book">
                    <div class="order-book-header">
                        <span>Price (NGN)</span>
                        <span>Amount ({{ coin.symbol }})</span>
                        <span>Total</span>
                    </div>
                    <!-- Sell Orders -->
                    <div id="sellOrders">
                        <div class="order-book-row price-down">
                            <span>₦{{ coin.price|add:5000|floatformat:2|intcomma }}</span>
                            <span>0.0234</span>
                            <span>₦{{ coin.price|add:5000|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="order-book-row price-down">
                            <span>₦{{ coin.price|add:3000|floatformat:2|intcomma }}</span>
                            <span>0.0567</span>
                            <span>₦{{ coin.price|add:3000|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="order-book-row price-down">
                            <span>₦{{ coin.price|add:1000|floatformat:2|intcomma }}</span>
                            <span>0.1234</span>
                            <span>₦{{ coin.price|add:1000|floatformat:0|intcomma }}</span>
                        </div>
                    </div>
                    
                    <!-- Current Price -->
                    <div class="order-book-row" style="background-color: var(--muted); font-weight: bold; margin: 8px 0;">
                        <span>₦{{ coin.price|floatformat:2|intcomma }}</span>
                        <span>Current Price</span>
                        <span></span>
                    </div>
                    
                    <!-- Buy Orders -->
                    <div id="buyOrders">
                        <div class="order-book-row price-up">
                            <span>₦{{ coin.price|add:-1000|floatformat:2|intcomma }}</span>
                            <span>0.2345</span>
                            <span>₦{{ coin.price|add:-1000|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="order-book-row price-up">
                            <span>₦{{ coin.price|add:-3000|floatformat:2|intcomma }}</span>
                            <span>0.3456</span>
                            <span>₦{{ coin.price|add:-3000|floatformat:0|intcomma }}</span>
                        </div>
                        <div class="order-book-row price-up">
                            <span>₦{{ coin.price|add:-5000|floatformat:2|intcomma }}</span>
                            <span>0.4567</span>
                            <span>₦{{ coin.price|add:-5000|floatformat:0|intcomma }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Trading Forms Section -->
        <div class="lg:col-span-1">
            <!-- Account Balance -->
            <div class="bg-card border border-border rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">Account Balance</h3>
                <div class="balance-item">
                    <span class="text-muted-foreground">NGN Balance</span>
                    <span class="font-medium">₦{{ user.ngn_balance|default:0|floatformat:2|intcomma }}</span>
                </div>
                <div class="balance-item">
                    <span class="text-muted-foreground">{{ coin.symbol }} Balance</span>
                    <span class="font-medium">{{ user.crypto_balance|default:0|floatformat:6 }} {{ coin.symbol }}</span>
                </div>
            </div>

            <!-- Buy Crypto Form -->
            <div class="trading-form">
                <h3 class="text-lg font-semibold mb-4 price-up">Buy {{ coin.symbol }}</h3>
                <form method="post" action="">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Current Price</label>
                        <input type="text" 
                               class="input-field" 
                               value="₦{{ coin.price|floatformat:2 }}" 
                               readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Amount to Spend (NGN)</label>
                        <input type="number" 
                               name="ngn_amount" 
                               class="input-field" 
                               step="0.01" 
                               placeholder="Enter NGN amount"
                               id="buyNgnAmount">
                        <div class="percentage-buttons">
                            <button type="button" class="percentage-btn" onclick="setBuyPercentage(25)">25%</button>
                            <button type="button" class="percentage-btn" onclick="setBuyPercentage(50)">50%</button>
                            <button type="button" class="percentage-btn" onclick="setBuyPercentage(75)">75%</button>
                            <button type="button" class="percentage-btn" onclick="setBuyPercentage(100)">100%</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">{{ coin.symbol }} You Will Receive</label>
                        <input type="number" 
                               name="crypto_amount" 
                               class="input-field" 
                               readonly 
                               id="buyReceiveAmount">
                    </div>
                    
                    <button type="submit" class="btn-buy">
                        Buy {{ coin.symbol }}
                    </button>
                </form>
            </div>

            <!-- Sell Crypto Form -->
            <div class="trading-form">
                <h3 class="text-lg font-semibold mb-4 price-down">Sell {{ coin.symbol }}</h3>
                <form method="post" action="">
                    {% csrf_token %}
                    <div class="form-group">
                        <label class="form-label">Current Price</label>
                        <input type="text" 
                               class="input-field" 
                               value="₦{{ coin.price|floatformat:2 }}" 
                               readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">{{ coin.symbol }} Amount to Sell</label>
                        <input type="number" 
                               name="crypto_amount" 
                               class="input-field" 
                               step="0.000001" 
                               placeholder="0.00000000"
                               id="sellAmount">
                        <div class="percentage-buttons">
                            <button type="button" class="percentage-btn" onclick="setSellPercentage(25)">25%</button>
                            <button type="button" class="percentage-btn" onclick="setSellPercentage(50)">50%</button>
                            <button type="button" class="percentage-btn" onclick="setSellPercentage(75)">75%</button>
                            <button type="button" class="percentage-btn" onclick="setSellPercentage(100)">100%</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Wallet Address</label>
                        <input type="text" 
                               name="wallet_address" 
                               class="input-field" 
                               placeholder="Enter your {{ coin.symbol }} wallet address"
                               required
                               id="sellWalletAddress">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">NGN You Will Receive</label>
                        <input type="number" 
                               name="ngn_amount" 
                               class="input-field" 
                               readonly 
                               id="sellReceiveAmount">
                    </div>
                    
                    <button type="submit" class="btn-sell">
                        Sell {{ coin.symbol }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
    // Expose Django price safely
    const basePrice = parseFloat("{{ coin.price|floatformat:2 }}");
    const ngnBalance = parseFloat("{{ user.ngn_balance|default:0 }}");
    const cryptoBalance = parseFloat("{{ user.crypto_balance|default:0 }}");

    // Chart initialization
    const ctx = document.getElementById('priceChart').getContext('2d');
    let priceChart;

    // Generate initial chart data using base price
    const generateSampleData = () => {
        const data = [];
        const labels = [];

        for (let i = 23; i >= 0; i--) {
            const date = new Date();
            date.setHours(date.getHours() - i);
            labels.push(date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));

            // Small random variation around base price
            const variation = (Math.random() - 0.5) * basePrice * 0.05;
            data.push(basePrice + variation);
        }

        return { labels, data };
    };

    const initChart = () => {
        const { labels, data } = generateSampleData();

        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ coin.symbol }}/NGN',
                    data: data,
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: value => '₦' + value.toLocaleString()
                        }
                    },
                    x: {
                        grid: { display: false }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    };

    // Trading functions
    function setBuyPercentage(percentage) {
        const price = parseFloat(document.getElementById('buyPrice').value) || basePrice;
        const availableAmount = (ngnBalance * percentage / 100) / price;
        document.getElementById('buyAmount').value = availableAmount.toFixed(6);
        updateBuyTotal();
    }

    function setSellPercentage(percentage) {
        const sellAmount = cryptoBalance * percentage / 100;
        document.getElementById('sellAmount').value = sellAmount.toFixed(6);
        updateSellTotal();
    }

    function updateBuyTotal() {
        const price = parseFloat(document.getElementById('buyPrice').value) || basePrice;
        const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
        document.getElementById('buyTotal').value = (price * amount).toFixed(2);
    }

    function updateSellTotal() {
        const price = parseFloat(document.getElementById('sellPrice').value) || basePrice;
        const amount = parseFloat(document.getElementById('sellAmount').value) || 0;
        document.getElementById('sellTotal').value = (price * amount).toFixed(2);
    }

    // Event listeners for form inputs
    document.addEventListener('DOMContentLoaded', function() {
        initChart();

        document.getElementById('buyPrice').addEventListener('input', updateBuyTotal);
        document.getElementById('buyAmount').addEventListener('input', updateBuyTotal);

        document.getElementById('sellPrice').addEventListener('input', updateSellTotal);
        document.getElementById('sellAmount').addEventListener('input', updateSellTotal);
    });

    // Simulate real-time price updates (replace with WebSocket in production)
    setInterval(() => {
        const variation = (Math.random() - 0.5) * basePrice * 0.001;
        const newPrice = basePrice + variation;

        document.getElementById('currentPrice').textContent = '₦' + newPrice.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }, 5000);
</script>


{% endblock %}